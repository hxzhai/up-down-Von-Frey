import streamlit as st
import pandas as pd
import numpy as np

# ----------------------------
# é¡µé¢è®¾ç½®
# ----------------------------
st.set_page_config(page_title="50% ç¼©è¶³é˜ˆå€¼è®¡ç®—", layout="wide")
st.info("ðŸ‘‰ è¯·ç‚¹å‡»å·¦ä¸Šè§’çš„ 'Â»Â»' å›¾æ ‡å±•å¼€ä¾§è¾¹æ ï¼Œå¡«å†™å‚æ•°åŽå¼€å§‹è®¡ç®—ã€‚")
st.title("ðŸ­ Von Frey 50% ç¼©è¶³é˜ˆå€¼è®¡ç®—å·¥å…·")

# ----------------------------
# è¯»å–æ•°æ®
# ----------------------------
try:
    code_df = pd.read_csv("ç¼–å·è¡¨.txt", sep="\t")
    k_df = pd.read_csv("kå€¼è¡¨.txt", sep="\t", dtype={"æµ‹é‡ç»“æžœ": str})  # ä¿ç•™å‰å¯¼ 0
except Exception as e:
    st.error("âŒ æ— æ³•è¯»å–ç¼–å·è¡¨æˆ– k å€¼è¡¨ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ã€‚")
    st.stop()

# æ£€æŸ¥åˆ—å
if 'å…‹æ•°' not in code_df.columns or 'åºå·' not in code_df.columns:
    st.error("âŒ ç¼–å·è¡¨æ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»åŒ…å« 'å…‹æ•°'ã€'åºå·' åˆ—ã€‚")
    st.stop()

if 'æµ‹é‡ç»“æžœ' not in k_df.columns or 'kå€¼' not in k_df.columns:
    st.error("âŒ k å€¼è¡¨æ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»åŒ…å« 'æµ‹é‡ç»“æžœ'ã€'kå€¼' åˆ—ã€‚")
    st.stop()

# âœ… æ›¿æ¢ç¼–å·åˆ—ä¸º log10(å…‹é‡ Ã— 10000)
code_df["ç¼–å·"] = np.log10(code_df["å…‹æ•°"] * 10000)

# ----------------------------
# ç”¨æˆ·è¾“å…¥åŒºåŸŸ
# ----------------------------
with st.sidebar.expander("ðŸ“ æ–¹æ³•åŽŸç†ä¸Žæ“ä½œè¯´æ˜Žï¼ˆç‚¹å‡»å±•å¼€ï¼‰", expanded=False):
    st.markdown("""
### ðŸ“ æ–¹æ³•åŽŸç†ç®€ä»‹

æœ¬å·¥å…·ä¾æ® **Dixon æå‡ºçš„ Up-Down æ–¹æ³•**ï¼Œå¯¹ä¸€ç³»åˆ— Von Frey åˆºæ¿€ä¸çš„åˆºæ¿€ç»“æžœè¿›è¡Œé€»è¾‘å›žæº¯ï¼Œç»“åˆå®žéªŒæ‰€ç”¨çº¤ç»´ä¸çš„ç¼–å·é—´è·ï¼ˆÎ´ï¼‰ä¸ŽåŒ¹é…çš„ç»éªŒå€¼ k å€¼ï¼Œè®¡ç®— 50% ç¼©è¶³ååº”çš„åˆºæ¿€å¼ºåº¦é˜ˆå€¼ã€‚

**è®¡ç®—å…¬å¼ï¼š**  
â€ƒâ€ƒ50% ç¼©è¶³é˜ˆå€¼ï¼ˆå…‹ï¼‰ = 10 ^ (Xf + k Ã— Î´) / 10000

å…¶ä¸­ï¼š
- **Xf**ï¼šæœ€åŽä¸€æ¬¡æµ‹è¯•çº¤ç»´ä¸çš„å¯¹æ•°ç¼–å·ï¼ˆlogâ‚â‚€(å…‹é‡ Ã— 10000)ï¼‰
- **k**ï¼šä¸Žååº”åºåˆ—å¯¹åº”çš„ç»éªŒç³»æ•°ï¼ˆç”±è¡¨æŸ¥å¾—ï¼‰
- **Î´**ï¼šåˆºæ¿€ä¸ç¼–å·ä¹‹é—´çš„å¹³å‡é—´è·ï¼ˆlogâ‚â‚€ ç¼–å·å·®å€¼ï¼‰

---

### ðŸ§ª Von Frey æ“ä½œè¯´æ˜Ž

1. **é€‰æ‹©æµ‹è¯•ç”¨åˆºæ¿€ä¸ï¼š**  
   å»ºè®®é€‰å– **5ï½ž9 æ ¹å…‹é‡è¿žç»­ã€ç¼–å·é—´è·è¿‘ä¼¼å‡åŒ€** çš„ Von Frey åˆºæ¿€ä¸ä½œä¸ºæµ‹è¯•ç»„ã€‚

2. **ç¡®å®šèµ·å§‹åˆºæ¿€ä¸ï¼š**  
   æµ‹è¯•åº”ä»Žæ‰€é€‰åˆºæ¿€ä¸ä¸­ **ä¸­é—´å…‹é‡çš„ä¸€æ ¹** å¼€å§‹åˆºæ¿€  
   ï¼ˆå¦‚é€‰æ‹©äº† 0.07gã€0.16gã€0.4gã€0.6gã€1gï¼Œåˆ™ä»Ž 0.4g å¼€å§‹ï¼‰ã€‚

3. **è®°å½•ååº”åºåˆ—ï¼ˆ0/1ï¼‰ï¼š**
   - 0 è¡¨ç¤ºé˜´æ€§ååº”ï¼ˆæ— ç¼©è¶³ï¼‰
   - 1 è¡¨ç¤ºé˜³æ€§ååº”ï¼ˆæœ‰ç¼©è¶³ï¼‰
   - æ¯æ¬¡æ ¹æ®ååº”ç»“æžœé€‰æ‹©ä¸‹ä¸€æ ¹åˆºæ¿€ä¸ï¼š
     - **è‹¥ä¸ºé˜³æ€§ï¼ˆ1ï¼‰ â†’ ç”¨æ›´è½»çš„çº¤ç»´ä¸**
     - **è‹¥ä¸ºé˜´æ€§ï¼ˆ0ï¼‰ â†’ ç”¨æ›´é‡çš„çº¤ç»´ä¸**

4. **ç»ˆæ­¢æ¡ä»¶ï¼š**  
   å½“è§‚å¯Ÿåˆ°é¦–æ¬¡é˜´æ€§ä¸Žé˜³æ€§ä¹‹é—´çš„ååº”è½¬å˜åŽï¼Œ**ç»§ç»­æµ‹è¯• 4 æ¬¡**å³ç»ˆæ­¢ã€‚

5. **è¾“å…¥ååº”åºåˆ—ï¼š**  
   - æ¯è¡Œè¾“å…¥ä¸€ç»„å®Œæ•´ååº”åºåˆ—ï¼ˆå¦‚ `00010101`ï¼‰ï¼›
   - **å¿…é¡»ä»Žæœ€ä¸­é—´å…‹é‡çš„çº¤ç»´ä¸å¼€å§‹è®°å½•**ï¼Œè€Œä¸æ˜¯ä»Žååº”å‘ç”Ÿå˜åŒ–ä¹‹åŽå¼€å§‹è®°å½•ã€‚

---

### âš™ï¸ ä½¿ç”¨æœ¬å·¥å…·æ­¥éª¤

1. ç‚¹å‡»å·¦ä¸Šè§’ ã€ŒÂ»ã€æŒ‰é’® å±•å¼€ä¾§è¾¹æ ï¼›
2. é€‰æ‹©æµ‹è¯•ä½¿ç”¨çš„ **æœ€å°å…‹é‡** ä¸Ž **æœ€å¤§å…‹é‡**ï¼›
3. åœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥ä¸€è¡Œæˆ–å¤šè¡Œååº”åºåˆ—ï¼ˆæ¯è¡Œä¸€ç»„ï¼‰ï¼›
4. ç‚¹å‡»â€œðŸš€ å¼€å§‹è®¡ç®—â€ï¼›
5. æŸ¥çœ‹è®¡ç®—ç»“æžœå¹¶ä¸‹è½½ CSV æ–‡ä»¶ã€‚

---
###ðŸ“®å¦‚éœ€è¿›ä¸€æ­¥å¸®åŠ©æˆ–ä¿®æ”¹ï¼Œè¯·è”ç³»ç»´æŠ¤è€… e-mailï¼šzhaihexin1999@163.com
    """)

st.sidebar.header("ðŸ“… å‚æ•°è®¾ç½®")

min_weight = st.sidebar.selectbox("é€‰æ‹©æœ€å°åˆºæ¿€ä¸å…‹é‡", options=code_df["å…‹æ•°"].tolist())
max_weight = st.sidebar.selectbox("é€‰æ‹©æœ€å¤§åˆºæ¿€ä¸å…‹é‡", options=code_df["å…‹æ•°"].tolist())
seq_input = st.sidebar.text_area("è¾“å…¥ååº”åºåˆ—ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰")
start = st.sidebar.button("ðŸš€ å¼€å§‹è®¡ç®—")

# ----------------------------
# è®¡ç®—å‡†å¤‡
# ----------------------------
sub_df = code_df[(code_df["å…‹æ•°"] >= min_weight) & (code_df["å…‹æ•°"] <= max_weight)].copy()

if sub_df.empty:
    st.error("âŒ æ‰€é€‰å…‹é‡èŒƒå›´æ— åŒ¹é…ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚")
    st.stop()

min_order = sub_df["åºå·"].min()
max_order = sub_df["åºå·"].max()
n_fibers = max_order - min_order + 1
median_order = (min_order + max_order) // 2

st.markdown(f"âœ… å·²é€‰ {n_fibers} æ ¹åˆºæ¿€ä¸ï¼Œä¸­ä½åºå·ä¸ºï¼š`{median_order}`")

# âœ… ç”¨é€‰æ‹©çš„ç»„ä»¶èŒƒå›´å†…ç¼–å·è®¡ç®—æ‰€æœ‰ç»„ä»¶çš„æœ€å¤§å’Œæœ€å°ç¼–å·
delta = (sub_df["ç¼–å·"].max() - sub_df["ç¼–å·"].min()) / (max_order - min_order)

# ----------------------------
# ä¸»è®¡ç®—
# ----------------------------
if start:
    st.subheader("ðŸ”¹ è®¡ç®—ç»“æžœ")

    k_df["æµ‹é‡ç»“æžœ"] = k_df["æµ‹é‡ç»“æžœ"].astype(str).str.replace(r"[\s\r\n\t]", "", regex=True)
    k_df["kå€¼"] = pd.to_numeric(k_df["kå€¼"], errors="coerce")

    seq_list = [line.strip() for line in seq_input.strip().splitlines() if line.strip()]
    results = []

    for seq in seq_list:
        seq_clean = ''.join(ch for ch in seq if ch in ['0', '1'])
        cur_order = median_order
        for ch in seq_clean[:-1]:  # âœ… åªç§»åŠ¨åˆ°å€’æ•°ç¬¬2æ­¥
            if ch == "0":
                cur_order += 1
            elif ch == "1":
                cur_order -= 1
            cur_order = max(min_order, min(max_order, cur_order))

        row = code_df[code_df["åºå·"] == cur_order]
        if row.empty:
            results.append({"ååº”åºåˆ—": seq_clean, "é”™è¯¯": "æ‰¾ä¸åˆ°å¯¹åº”åºå·"})
            continue

        xf = row["ç¼–å·"].values[0]
        final_weight = row["å…‹æ•°"].values[0]

        if not k_df["æµ‹é‡ç»“æžœ"].isin([seq_clean]).any():
            results.append({"ååº”åºåˆ—": seq_clean, "é”™è¯¯": "k å€¼è¡¨ä¸­æœªæ‰¾åˆ°è¯¥åºåˆ—"})
            continue

        try:
            k_val = float(k_df.loc[k_df["æµ‹é‡ç»“æžœ"] == seq_clean, "kå€¼"].values[0])
        except:
            results.append({"ååº”åºåˆ—": seq_clean, "é”™è¯¯": "k å€¼æ— æ³•è½¬æ¢ä¸ºæ•°å€¼"})
            continue

        threshold_log = xf + k_val * delta
        threshold_g = 10 ** threshold_log / 10000

        results.append({
            "ååº”åºåˆ—": seq_clean,
            "æœ€åŽåˆºæ¿€ä¸å…‹é‡": final_weight,
            "Xfï¼ˆç¼–å·ï¼‰": round(xf, 3),
            "k å€¼": k_val,
            "delta": round(delta, 4),
            "50% ç¼©è¶³é˜ˆå€¼ï¼ˆå…‹ï¼‰": round(threshold_g, 4)
        })

    df_result = pd.DataFrame(results)
    st.dataframe(df_result, use_container_width=True)

    csv = df_result.to_csv(index=False).encode("utf-8-sig")
    st.download_button(
        label="ðŸ“… ä¸‹è½½ç»“æžœä¸º CSV",
        data=csv,
        file_name="VonFrey_ç»“æžœ.csv",
        mime="text/csv"
    )
